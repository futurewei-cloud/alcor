= Route Manager Design Specification
Chun-Jen Chung <cchung@futurewei.com>, Liguang Xie <lxie@futurewei.com>
v0.1, 2020-08-17
:toc: right
:imagesdir: ../../images

== Overview

The Route Manager is an Alcor microservice which manages the route tables and route entries for all VPCs and Subnets.
It also provides router-related functionalities to compatible with OpenStack Neutron's router APIs.
Its responsibilities include but are not limited to creating, updating, deleting, and searching routers, route tables,
and route entries resource for a Network/VPC/Subnet.
It interacts with VPM Manager, Subnet Manager, Port Manager, and Data Plane Manager to provide route information for them.

== Service Requirements

[arabic]
. Availability Zone and Subnet-based route table.
. Default route tables for VPC and subnet.
. Default route to Internet Gateway in a public subnet route table.
. Default route to NAT Gateway in a private subnet route table.
. Router resource managed by an owner, Neutron or VPC.
. Route table resource managed by an owner, VPC or Subnet.
. Route entry should include destination, nexthop, target, and priority.
. Warning message should be raised if same route entry with different priority has been inserted by users.
. Route Manager should provide APIs for OpenStack Neutron's Router operations.

== Design
In order to compatible with both OpenStack Neutron's router concept and VPC's routing table concept in a public cloud,
the main resource for route manager is designed as a three-layer structure:

image::router_three_layers_strcuture.png[]

=== Service Architecture

=== Key Workflow

== Database Schema
=== Router
....
{
    "router": {
        "admin_state_up": true,
        "availability_zone_hints": [],
        "availability_zones": [
            "nova"
        ],
        "created_at": "2018-03-19T19:17:04Z",
        "description": "",
        "distributed": false,
        "external_gateway_info": {
            "enable_snat": true,
            "external_fixed_ips": [
                {
                    "ip_address": "172.24.4.6",
                    "subnet_id": "b930d7f6-ceb7-40a0-8b81-a425dd994ccf"
                },
                {
                    "ip_address": "2001:db8::9",
                    "subnet_id": "0c56df5d-ace5-46c8-8f4c-45fa4e334d18"
                }
            ],
            "network_id": "ae34051f-aa6c-4c75-abf5-50dc9ac99ef3"
        },
        "flavor_id": "f7b14d9a-b0dc-4fbe-bb14-a0f4970a69e0",
        "ha": false,
        "id": "f8a44de0-fc8e-45df-93c7-f79bf3b01c95",
        "name": "router1",
        "revision_number": 1,
        "routetables": [ "routetable1", "routetable2", ... ],
        "status": "ACTIVE",
        "updated_at": "2018-03-19T19:17:22Z",
        "project_id": "0bd18306d801447bb457a46252d82d13",
        "tenant_id": "0bd18306d801447bb457a46252d82d13",
        "service_type_id": null,
        "tags": ["tag1,tag2"],
        "conntrack_helpers": []
    }
}
....
=== Route Table
....
{
    "routetable": {
        "id": "xxxxxxx",
        "name": "routetale1",
        "description": "xxxxx",
        "public": true
        "routes": [ "route1", "route2", ...]
    }
}
....
=== Route Entry
....
{
    "routes": {
        "id": "route1",
        "name": "route name",
        "description": "xxx",
        "destination": "179.24.1.0/24",
        "nexthop": "172.24.3.99",
        "target": "172.24.3.99",
        "priority": 100
    }
}
....

== REST APIs

=== API Snapshot

[width="100%",cols="22%,12%,50%,17%"]
|===
|*API Name* |*Method* |*Request*|*Response*

|Get/Verify VPC State By VPC Id
|GET
|/project/{projectid}/vpcs/{vpcid}, /v4/{projectid}/vpcs/{vpcid}
|VPC state
<<VpcState_Get1,[sample]>>

|Create VPC StateS
|POST
|/project/{projectid}/vpcs, /v4/{projectid}/vpcs
|VPC state
<<VpcState_Post1,[sample]>>

|Update VPC Address
|PUT
|/project/{projectid}/vpcs/{vpcid}, /v4/{projectid}/vpcs/{vpcid}
|VPC state
<<VpcState_Put1,[sample]>>

|Delete VPC Address
|DELETE
|/project/{projectid}/vpcs/{vpcid}, /v4/{projectid}/vpcs/{vpcid}
|ResponseId
<<VpcState_Delete1,[sample]>>

|GET VPC State By Project Id
|GET
|/project/{projectid}/vpcs
|Map
<<VpcState_Get2,[sample]>>
|===

=== API Specification

anchor:VpcState_Get1[]
**(1) Get/Verify VPC state by VPC Id**

* Method: `GET`

* Request: `/project/{projectid}/vpcs/{vpcid}, /v4/{projectid}/vpcs/{vpcid}`

* Request Parameter: `@PathVariable String projectid, @PathVariable String vpcid`

* Response: vpc state
* Normal response codes: 200
* Error response codes: 400, 404, 500

* Example

....
Request:
http://localhost:8080/project/3dda2801-d675-4688-a63f-dcda8d327f50/vpcs/9192a4d4-ffff-4ece-b3f0-8d36e3d88038

Response:
{
  "network": {
    "project_id": "3dda2801-d675-4688-a63f-dcda8d327f50",
    "id": "9192a4d4-ffff-4ece-b3f0-8d36e3d88038",
    "name": "vpc_test1",
    "cidr": "00-14-2A-3B-47-37",
  }
}
....

anchor:VpcState_Post1[]
**(1) Create VPC State**

* Method: `POST`

* Request: `/project/{projectid}/vpcs, /v4/{projectid}/vpcs`

* Request Parameter: `@PathVariable String projectid, @RequestBody VpcsWebJson resource`

* Response: vpc state
* Normal response codes: 201
* Error response codes: 400, 404, 500, 503

* Example

....
Request:
http://localhost:8080/project/3dda2801-d675-4688-a63f-dcda8d327f50/vpcs
--data "{\"vpc\":{\"project_id\":\"3dda2801-d675-4688-a63f-dcda8d327f50\",\"id\":\"9192a4d4-ffff-4ece-b3f0-8d36e3d88038\",\"name\":\"test_vpc\",\"description\":\"vpc\",\"cidr\":\"10.0.0.0/16\"}}"

Response:
{
  "network": {
    "project_id": "3dda2801-d675-4688-a63f-dcda8d327f50",
    "id": "9192a4d4-ffff-4ece-b3f0-8d36e3d88038",
    "name": "test_vpc",
    "cidr": "10.0.0.0/16",
    "description": "vpc"
  }
}
....

anchor:VpcState_Put1[]
**(1) Update VPC State**

* Method: `PUT`

* Request: `/project/{projectid}/vpcs/{vpcid}, /v4/{projectid}/vpcs/{vpcid}`

* Request Parameter: `@PathVariable String projectid, @PathVariable String vpcid, @RequestBody VpcWebRequestJson resource`

* Response: vpc state
* Normal response codes: 201
* Error response codes: 400, 404, 500, 503

* Example

....
Request:
http://localhost:8080/project/3dda2801-d675-4688-a63f-dcda8d327f50/vpcs/9192a4d4-ffff-4ece-b3f0-8d36e3d88038
--data "{\"vpc\":{\"project_id\":\"3dda2801-d675-4688-a63f-dcda8d327f50\",\"id\":\"9192a4d4-ffff-4ece-b3f0-8d36e3d88038\",\"name\":\"test_vpc\",\"description\":\"vpc\",\"cidr\":\"10.0.0.0/16\"}}"

Response:
{
  "network": {
    "project_id": "3dda2801-d675-4688-a63f-dcda8d327f50",
    "id": "9192a4d4-ffff-4ece-b3f0-8d36e3d88038",
    "name": "test_vpc",
    "cidr": "10.0.0.0/16",
    "description": "vpc"
  }
}
....

anchor:VpcState_Delete1[]
**(1) Delete VPC State**

* Method: `DELETE`

* Request: `/project/{projectid}/vpcs/{vpcid}, /v4/{projectid}/vpcs/{vpcid}`

* Request Parameter: `@PathVariable String projectid, @PathVariable String vpcid`

* Response: ResponseId
* Normal response codes: 200
* Error response codes: 400, 404, 500

* Example

....
Request:
http://localhost:8080/project/3dda2801-d675-4688-a63f-dcda8d327f50/vpcs/9192a4d4-ffff-4ece-b3f0-8d36e3d88038

Response:
{"id": "9192a4d4-ffff-4ece-b3f0-8d36e3d88038"}
....

anchor:VpcState_Get2[]
**(1) Get/Verify VPC state by Project Id**

* Method: `GET`

* Request: `/project/{projectid}/vpcs`

* Request Parameter: `@PathVariable String projectid`

* Response: map
* Normal response codes: 200
* Error response codes: 400, 404, 500

* Example

....
Request:
http://localhost:8080/project/3dda2801-d675-4688-a63f-dcda8d327f50/vpcs

Response:
Map<String, VpcWebResponseObject> vpcStates
....

== Concurrency Handling
When creating segments, we need to concurrently create instances of network type (vlan, vxlan, gre), and multiple instances may assign their key Id.

Sample for allocating vlan key
....
public synchronized Long allocateVlanKey (String rangeId) throws Exception {
        Long key;

        try (Transaction tx = cache.getTransaction().start()) {
            NetworkVlanRange networkVlanRange = cache.get(rangeId);
            if (networkVlanRange == null) {
                throw new RangeNotFoundException();
            }

            key = networkVlanRange.allocateKey();
            cache.put(networkVlanRange.getId(), networkVlanRange);

            tx.commit();
        }

        return key;
    }
....
//include::../../../services/vpc_manager/target/swagger/swagger.adoc[]
