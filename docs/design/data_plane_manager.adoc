= Data-Plane Manager Design Specification
Xiaodong Zhang <xzhang2@futurewei.com>, Liguang Xie <lxie@futurewei.com>
v0.1, 2020-04-30
:toc: right

== Overview

The Data-plane manager is a control plane component responsible of driving network configuration down to the control agents installed on the physical hosts.
It provides a flexible plugin framework which allows different data-plane extension.

=== User Cases

{empty}(1) Port Manger wants to send one new port information to every hosts in the VPC +
(2) Security Group Manager wants to send one new security group to hosts in the VPC

== Service Requirements

=== Basic Requirements

[arabic]
. Provide a flexible plugin framework which allows different data-plane extensions.
. OVS extension supports integration with OVS
. Reliably connecting to hosts through various paths including normal path (kafka) and fast path (gPRC)
. Configurable retry mechanism when connection to hosts is unstable
. Working together with other services including port manager and security group manager.
. Concurrency control mechanism should be provided to process multiple concurrent network configuration programming requests.

=== Advanced Requirements

Fall back mechanism from one path to the other, for example, from fast path to normal path, or from normal path to rescue path

== Data-Plane Microservice Design

=== Architecture

image:images/dpm.png[image,width=660,height=384]

[Figure 1] Data Plane Manager Structure

=== Extensible Design to Support Various Data-Plane

Upstream microservices doesn't need to know about the actual data-plane implementation.

. OVS Extension
. Mizar Gateway Extension (later)

=== Key Worfklow

. Create first port in a subnet

image:images/dpm2.png[image,width=660,height=384]

[Figure 2] create first port 

image:images/dpm3.png[image,width=660,height=384]

[Figure 3] create first port 

. Create a port in an existing subnet
. Update a port
. Get a port
. Delete a port

=== Concurrency Control

Data plane manger service would do the provision work concurrently using multithread technology.

== Communication with Agent

=== Message Design
* For initial data we would do full update with nfs* support and notification on messaging Q
* We would use delta update for small amount of update to deploy
* NFS could support up to 30G/s speed and we could use advanced nfs to get half of response time with bypassing kernel 

=== Multi-path Control Logic

. Normal Path
. Fast Path
. Rescue Path

Logic:

. Initially we would use fast path (grpc) to tell agent the info about next step
. We would normally use normal path to do agent provision and nfs for big file (3GB file with gzip would cost about 3s)
. When heart beat loss decteted (via Netdata) , data plane manager would send out rescue message to MessagingQ to let adjacent ovs do remote rescue

==== Problems solution:

. To solve the misorder data, put them in same queue
. Use the tag to filter msg.
. RocketMQ could support way more topic number with stable performance, we need to fine tune the parameter for dirty page and memory usage
. Use bond to get more bandwidth for storm
image:images/bond.png[image,width=400,height=240]

[Figure 4] IP Bond

. Since Kafka would drop lots of performance when topic number is higher, RocketMQ is stable
image:images/dpm-mq3.png[image,width=550,height=270]

[Figure 5] Performance drop when topics nubmer is greater

image:images/dpm-mq1.png[image,width=400,height=240]

[Figure 6] Performance drop when topics nubmer is greater

. When message body is greater than 4k , the performance would drop greatly
image:images/dpm-mq2.png[image,width=400,height=240]

[Figure 7] Message size and the performance drop

. Here is the Neutron way to start ovs and do processing
image:images/neutron-dpm.png[image,width=660,height=384]

[Figure 8] Neutron way to start ovs and do processing

. GRPC is not fit for transfering big file since it basically focus more on the assumption of small numbers in the data

== Database Schema

[cols=",,,",options="header",]
|===
|Vpc_states |Subnet_ states |Port_ states |security_group_ states
| | | |
|===

State could contains more same type data as array

* DataPlaneManager would deploy the goal state configuration in batch to the ACA grouply in parallel then wait for the response and do next accordingly.

== REST APIs

=== API Snapshot

[width="100%",cols="22%,12%,50%,17%"]
|===
|*API Name* |*Method* |*Request*|*Response*

//|Verify IP State
//|GET
//|/ips/{ip_version}/{range_id}/{ip}
//|ip state
//<<IP_Get,[sample]>>

|===

=== API Specification

//anchor:IP_Get[]
//**(1) Get/Verify IP state by IP address**
//
//* Method: `GET`
//
//* Request: `/ips/{ip_version}/{range_id}/{ip}`
//
//* Request Parameter: `@PathVariable int ipVersion, @PathVariable String rangeId, @PathVariable String ip`
//
//* Response: ip state
//* Normal response codes: 200
//* Error response codes: 400, 412, 500
//
//* Example
//
//....
//Request:
//http://127.0.0.1:8080/ips/4/174ac5e4-7fb5-11ea-8cc4-000c29f4bc8b/10.10.10.1
//
//Response:
//{
//	"ip_version": 4,
//    "range_id": "174ac5e4-7fb5-11ea-8cc4-000c29f4bc8b",
//    "ip": "10.10.10.1",
//    “state” “activated”
//}

* Get
* Create
* Update
* Delete

==== (1) Get GoalState Info By GoalState Request

* {blank}
+
____
Method: GET
____
* {blank}
+
____
Request: 
____

____
/goalstate/{goalstateid},/v4/goalstate/{goalstateid}
____

* {blank}
+
____
Request Parameter: 
____
** @ PathVariable String portid
* {blank}
+
____
Response: List of GoalState Information
____
* {blank}
+
____
Example
____

Request:

http://serverIP:8080/goalstate/f37810eb-7f83-45fa-a4d4-1b31e75399df

Response:

[source,c++]
------------------------------------------------------------
{
  "goalstate": [{
    "vpc": {
      "project_id": "3dda2801-d675-4688-a63f-dcda8d327f50",
      "id": "9192a4d4-ffff-4ece-b3f0-8d36e3d88038",
      "name": "test_vpc",
      "description": "",
      "cidr": "10.0.0.0/16"
    },
    "subnet": {
      "project_id": "3dda2801-d675-4688-a63f-dcda8d327f50",
      "vpc_id": "9192a4d4-ffff-4ece-b3f0-8d36e3d88038",
      "id": "a87e0f87-a2d9-44ef-9194-9a62f178594e",
      "name": "test_subnet",
      "description": "",
      "cidr": "10.0.0.0/20",
      "gateway_ip": "10.0.0.5",
      "availability_zone": "uswest-1",
      "dhcp_enable": false,
      "primary_dns": null,
      "secondary_dns": null,
      "dns_list": null
    },
    "port": {
      "project_id": "3dda2801-d675-4688-a63f-dcda8d327f50",
      "id": "f37810eb-7f83-45fa-a4d4-1b31e75399df",
      "name": "test_cni_port2",
      "description": "",
      "network_id": "a87e0f87-a2d9-44ef-9194-9a62f178594e",
      "tenant_id": null,
      "admin_state_up": true,
      "mac_address": null,
      "veth_name": "veth0",
      "device_id": null,
      "device_owner": null,
      "status": null,
      "fixed_ips": [
        
      ],
      "allowed_address_pairs": null,
      "extra_dhcp_opts": null,
      "security_groups": null,
      "binding:host_id": "ephost_0",
      "binding:profile": null,
      "binding:vnic_type": null,
      "network_ns": "/var/run/netns/test_netw_ns",
      "dnsName": null,
      "dnsAssignment": null,
      "fast_path": true
    },
    "security_group": {
      "project_id": "3dda2801-d675-4688-a63f-dcda8d327f50",
      "version": 0,
      "vpc_id": "9192a4d4-ffff-4ece-b3f0-8d36e3d88038",
      "id": "f37810eb-7f83-45fa-a4d4-1b31e75399df",
      "name": "test_security_group1",
      "security_group_rules": null
    }
  }]
}
------------------------------------------------------------


====  (2) Send GoalState to create port

* {blank}
+
____
Method: POST
____
* {blank}
+
____
Request: /goalstate/{gsinfo}", "/v4/goalstate/{gsinfo}
____
* {blank}
+
____
Request Parameter: 
____
** @RequestBody GSInfo resource
* {blank}
+
____
Response: port creation result information
____
* {blank}
* Normal response codes: 200
* Error response codes: 400, 412, 500
+
____
Example
____

Request:

http://localhost:8080/goalstate/

Body:

------------------------------------------------------------
{
   "operation_type":"create",
   "resource_type":2,
   "goalstate":[
      {
         "gsinfo":{
            "project_id":"3dda2801-d675-4688-a63f-dcda8d327f50",
            "security_group_id":"f37810eb-7f83-45fa-a4d4-1b31e75399df",
            "veth_name":"eth0",
            "bridge_name": "test_br",
            "description":"test_port1",
            "port_id":"f37810eb-7f83-45fa-a4d4-1b31e75399df",
            "hostip":"192.168.1.2",
            "vpc":null,
            "subnet":null,
            "port":null,
            "security_group":null
         }
      }
      }
   ]
}
------------------------------------------------------------

[source,c++]
------------------------------------------------------------
Response:
{
"code":200
"desc":"ports f37810eb-7f83-45fa-a4d4-1b31e75399de and f37810eb-7f83-45fa-a4d4-1b31e75399df created on 192.168.1.2 successfully"
}

------------------------------------------------------------

====  (3) Send GoalState to delete port

* {blank}
+
____
* Method: `DELETE`
____
* {blank}
+
____
Request: /goalstate/{gsinfo}", "/v4/goalstate/{gsinfo}
____
* {blank}
+
____
Request Parameter: 
____
** @RequestBody GSInfo resource
* {blank}
+
____
Response: port deletion result
____
* {blank}
* Normal response codes: 200
* Error response codes: 400, 412, 500
+
____
Example
____

Request:

http://localhost:8080/goalstate/{gsinfo}

Body:

------------------------------------------------------------
{
   "operation_type":"delete",
   "resource_type":2,
   "goalstate":[
      {
         "gsinfo":{
            "project_id":"3dda2801-d675-4688-a63f-dcda8d327f50",
            "security_group_id": null,
            "veth_name":null,
            "bridge_name": "test_br",
            "description":"test_port1",
            "port_id":"f37810eb-7f83-45fa-a4d4-1b31e75399df",
            "hostip":"192.168.1.2",
            "vpc":null,
            "subnet":null,
            "port":null,
            "security_group":null
         }
      }
   ]
}
------------------------------------------------------------

[source,c++]
------------------------------------------------------------
Response:
{
"code":200
"desc":"port test_port1 on host 192.168.1.2 deleted successfully"
}

------------------------------------------------------------

====  (4) Send GoalState to update port

* {blank}
+
____
Method: `PUT`
____
* {blank}
+
____
Request: /goalstate/\{goalstates}", "v4/goalstate/\{goalstates}
____
* {blank}
+
____
Request Parameter: 
____
** @RequestBody GoalStateJson resource
* {blank}
+
____
Response: port update result information
____
* {blank}
* Normal response codes: 200
* Error response codes: 400, 412, 500
+
____
Example
____

Request:

http://localhost:8080/goalstate/goalstates

Body:

------------------------------------------------------------
{ "operation_type": "update",
  "resource_type": 2,
  "goalstate": [{
    "vpc": {
      "project_id": "3dda2801-d675-4688-a63f-dcda8d327f50",
      "id": "9192a4d4-ffff-4ece-b3f0-8d36e3d88038",
      "name": "test_vpc",
      "description": "",
      "cidr": "10.0.0.0/16"
    },
    "subnet": {
      "project_id": "3dda2801-d675-4688-a63f-dcda8d327f50",
      "vpc_id": "9192a4d4-ffff-4ece-b3f0-8d36e3d88038",
      "id": "a87e0f87-a2d9-44ef-9194-9a62f178594e",
      "name": "test_subnet",
      "description": "",
      "cidr": "10.0.0.0/20",
      "gateway_ip": "10.0.0.5",
      "availability_zone": "uswest-1",
      "dhcp_enable": false,
      "primary_dns": null,
      "secondary_dns": null,
      "dns_list": null
    },
    "port": {
      "project_id": "3dda2801-d675-4688-a63f-dcda8d327f50",
      "id": "f37810eb-7f83-45fa-a4d4-1b31e75399df",
      "name": "test_cni_port2",
      "description": "",
      "network_id": "a87e0f87-a2d9-44ef-9194-9a62f178594e",
      "tenant_id": null,
      "admin_state_up": true,
      "mac_address": null,
      "veth_name": "veth0",
      "device_id": null,
      "device_owner": null,
      "status": null,
      "fixed_ips": [
        
      ],
      "allowed_address_pairs": null,
      "extra_dhcp_opts": null,
      "security_groups": null,
      "binding:host_id": "ephost_0",
      "binding:profile": null,
      "binding:vnic_type": null,
      "network_ns": "/var/run/netns/test_netw_ns",
      "dnsName": null,
      "dnsAssignment": null,
      "fast_path": true
    },
    "security_group": {
      "project_id": "3dda2801-d675-4688-a63f-dcda8d327f50",
      "version": 0,
      "vpc_id": "9192a4d4-ffff-4ece-b3f0-8d36e3d88038",
      "id": "f37810eb-7f83-45fa-a4d4-1b31e75399df",
      "name": "test_security_group1",
      "security_group_rules": null
    }
  }]
}
------------------------------------------------------------

[source,c++]
------------------------------------------------------------
Response:
{
"code":200
"desc":"port f37810eb-7f83-45fa-a4d4-1b31e75399df updated successfully"
}

------------------------------------------------------------

====  (5) Send GoalState to create bulk ports

* {blank}
+
____
Method: POST
____
* {blank}
+
____
Request: /goalstates/{gsinfo}", "/v4/goalstates/{gsinfo}
____
* {blank}
+
____
Request Parameter: 
____
** @RequestBody GSInfo resource
* {blank}
+
____
Response: ports creation result information
____
* {blank}
* Normal response codes: 200
* Error response codes: 400, 412, 500
+
____
Example
____

Request:

http://localhost:8080/goalstates/

Body:

------------------------------------------------------------
{
   "operation_type":"create",
   "resource_type":2,
   "goalstate":[
      {
         "gsinfo":{
            "project_id":"3dda2801-d675-4688-a63f-dcda8d327f50",
            "security_group_id":"f37810eb-7f83-45fa-a4d4-1b31e75399df",
            "veth_name":"eth0",
            "bridge_name": "test_br",
            "description":"test_port1",
            "port_id":"f37810eb-7f83-45fa-a4d4-1b31e75399df",
            "hostip":"192.168.1.2",
            "vpc":null,
            "subnet":null,
            "port":null,
            "security_group":null
         }
      },
      {
         "gsinfo":{
            "project_id":"3dda2801-d675-4688-a63f-dcda8d327f50",
            "security_group_id":"f37810eb-7f83-45fa-a4d4-1b31e75399df",
            "veth_name":"eth1",
            "bridge_name": "test_br",
            "description":"test_port2",
            "port_id":"f37810eb-7f83-45fa-a4d4-1b31e75399de",
            "hostip":"192.168.1.3",
            "vpc":null,
            "subnet":null,
            "port":null,
            "security_group":null
         }
      }
   ]
}
------------------------------------------------------------

[source,c++]
------------------------------------------------------------
Response:
{
"code":200
"desc":"ports f37810eb-7f83-45fa-a4d4-1b31e75399de and f37810eb-7f83-45fa-a4d4-1b31e75399df created successfully"
}

------------------------------------------------------------

====  (6) Send GoalState to bulkly delete ports

* {blank}
+
____
Method: DELETE
____
* {blank}
+
____
Request: /goalstates/{gsinfo}", "/v4/goalstates/{gsinfo}
____
* {blank}
+
____
Request Parameter: 
____
** @RequestBody GSInfo resource
* {blank}
+
____
Response: port creation result information
____
* {blank}
* Normal response codes: 200
* Error response codes: 400, 412, 500
+
____
Example
____

Request:

http://localhost:8080/goalstates/

Body:

------------------------------------------------------------
{
   "operation_type":"delete",
   "resource_type":2,
   "goalstate":[
      {
         "gsinfo":{
            "project_id":"3dda2801-d675-4688-a63f-dcda8d327f50",
            "security_group_id": null,
            "veth_name":null,
            "bridge_name": "test_br",
            "description":"test_port1",
            "port_id":"f37810eb-7f83-45fa-a4d4-1b31e75399df",
            "hostip":"192.168.1.2",
            "vpc":null,
            "subnet":null,
            "port":null,
            "security_group":null
         }
      },
      {
         "gsinfo":{
            "project_id":"3dda2801-d675-4688-a63f-dcda8d327f50",
            "security_group_id": null,
            "veth_name":null,
            "bridge_name": "test_br",
            "description":"test_port2",
            "port_id":"f37810eb-7f83-45fa-a4d4-1b31e75399de",
            "hostip":"192.168.1.3",
            "vpc":null,
            "subnet":null,
            "port":null,
            "security_group":null
         }
      }
   ]
}
------------------------------------------------------------

[source,c++]
------------------------------------------------------------
Response:
{
"code":200
"desc":"bulk ports 9192a4d4-ffff-4ece-b3f0-8d36e3d88038 and 9192a4d4-ffff-4ece-b3f0-8d36e3d88039 deleted on hosts 192.168.1.2 and 192.168.1.3 successfully"
}

------------------------------------------------------------


[bibliography]
== References

- [[[fw_issue,1]]] https://github.com/futurewei-cloud/alcor/issues/166
